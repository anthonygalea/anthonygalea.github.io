<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en-us">
<head>
  <link href="http://gmpg.org/xfn/11" rel="profile">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <meta name="viewport" content="width=device-width">

  <title>Simulating a parking garage with Clojure Refs</title>

  <link href="https://www.anthony-galea.com/favicon.png" rel="icon">

  <style media="screen">
    .navbar,.navbar>.container>.title{position:fixed}.links,time{float:right}.label,abbr,dt{font-weight:700}*{-webkit-box-sizing:border-box;-moz-box-sizing:border-box;box-sizing:border-box}body,html{margin:0;padding:0}html{font-family:Lato,Helvetica,Arial,sans-serif;font-size:16px;line-height:1.25}body{color:#515151;background-color:#fff;-webkit-text-size-adjust:100%;-ms-text-size-adjust:100%}.olist,.paragraph,.post-date,.pygments,.quoteblock,.ulist,h1,h2,h3{max-width:56rem;margin:auto}.paragraph{margin-top:2rem;margin-bottom:2rem}p,pre{margin-top:0;margin-bottom:1rem}.post-footer,.post-header{background-color:#f9f9f9;padding-top:2rem;padding-bottom:1.5rem}.post-footer ul{line-height:1.5rem}.navbar{margin-right:0;margin-left:0;background-color:#337ab7;height:3rem;width:100%;z-index:100}code,pre,tbody tr:nth-child(odd) td,tbody tr:nth-child(odd) th{background-color:#f9f9f9}.navbar a{color:#fff;text-decoration:none!important}.links{line-height:1.9em;font-size:1.8em}.links .icon{fill:#fff}.icon{width:.8em;height:.9em}.navbar h1{color:#fff;margin-top:0;font-size:1.1rem;line-height:3rem}h1,h2,h4,h5,h6{margin-top:2rem}a{color:#337ab7;text-decoration:none}a:focus,a:hover{text-decoration:underline}h1,h2,h3,h4,h5,h6{font-weight:700;line-height:1.25;color:#2b2b2b;text-rendering:optimizeLegibility}h1{font-size:2rem}h2{font-size:1.5rem}h3{margin-top:1.5rem;font-size:1.25rem}h4,h5,h6{font-size:1rem}abbr,code{font-size:85%}strong{color:#303030}dl,ol,ul{margin-top:0}dd{margin-bottom:.5rem}hr{position:relative;margin:.5rem 0;border:0;border-top:1px solid #eee;border-bottom:1px solid #fff}abbr{color:#555;text-transform:uppercase}abbr[title]{cursor:help;border-bottom:1px dotted #e5e5e5}code,pre{font-family:Menlo,Monaco,"Courier New",monospace}code{padding:.25em .5em;color:#bf616a;border-radius:3px}pre{display:block;font-size:.8rem;line-height:1.4;white-space:pre;white-space:pre-wrap}pre code{padding:0;font-size:90%;color:inherit;background-color:transparent}.highlight{margin:auto;border-radius:4px;max-width:56rem}.highlight pre,blockquote p:last-child{margin-bottom:0}blockquote{margin:.8rem 0;color:#7a7a7a;border-left:.25rem solid #e5e5e5}@media (max-width:38em){a.label,time{display:none}}@media (min-width:30em){blockquote{padding-right:0;padding-left:1.25rem}}blockquote .paragraph{padding-top:1rem;padding-bottom:1rem}img{display:block;max-width:100%;margin:auto;border-radius:5px}table,td,th{border:1px solid #e5e5e5}table{margin:auto auto 1rem;border-collapse:collapse}td,th{padding:.25rem .5rem}.container{max-width:56rem;margin-left:auto;margin-right:auto}.page-title,.post-title,.post-title a{color:#2b2b2b}.page-title,.post-title{margin-top:-.6rem}.post-date{display:block;color:#9a9a9a}@media (min-width:48em){html{font-size:16px}}@media (min-width:58em){html{font-size:20px}}.content{padding-top:3rem;margin:0 auto}.posts{margin-bottom:2rem;list-style:none;margin-left:-2rem;max-width:60rem;font-size:.9rem;line-height:1.5rem;padding-top:2rem}.post p{margin:0;text-align:justify}.imageblock,.imageblock>.title,.label{text-align:center}pre{padding:0}.imageblock>.content,.listingblock>.content{margin:auto;padding-top:0;padding-bottom:0}.listingblock>.content{padding-top:.75rem;padding-bottom:.75rem;background-color:#272822}.label,.post .label{background-color:#337ab7;color:#fff}.label{display:inline;padding:.2em .6em .3em;font-size:75%;line-height:1;white-space:nowrap;vertical-align:baseline;border-radius:.25em;margin:0 .25em}a.label:focus,a.label:hover{color:#fff;text-decoration:none;cursor:pointer}.label:empty{display:none}.post-date a.label,.posts a.label{color:#fff;text-decoration:none;cursor:pointer}.tableblock .MathJax_Display,.tableblock p{margin:0}canvas{display:inline-block;margin:20px}
  </style>

  
  
  
  

  <meta name="description" content="">
  <meta name="keywords" content="clojure refs,introduction,tutorial,example">
  

  
</head>
<body>

  <svg aria-hidden="true" style="position: absolute; width: 0; height: 0; overflow: hidden;" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
  <defs>
    <symbol id="icon-github" viewBox="0 0 448 512">
      <path d="M400 32H48C21.5 32 0 53.5 0 80v352c0 26.5 21.5 48 48 48h352c26.5 0 48-21.5 48-48V80c0-26.5-21.5-48-48-48zM277.3 415.7c-8.4 1.5-11.5-3.7-11.5-8 0-5.4.2-33 .2-55.3 0-15.6-5.2-25.5-11.3-30.7 37-4.1 76-9.2 76-73.1 0-18.2-6.5-27.3-17.1-39 1.7-4.3 7.4-22-1.7-45-13.9-4.3-45.7 17.9-45.7 17.9-13.2-3.7-27.5-5.6-41.6-5.6-14.1 0-28.4 1.9-41.6 5.6 0 0-31.8-22.2-45.7-17.9-9.1 22.9-3.5 40.6-1.7 45-10.6 11.7-15.6 20.8-15.6 39 0 63.6 37.3 69 74.3 73.1-4.8 4.3-9.1 11.7-10.6 22.3-9.5 4.3-33.8 11.7-48.3-13.9-9.1-15.8-25.5-17.1-25.5-17.1-16.2-.2-1.1 10.2-1.1 10.2 10.8 5 18.4 24.2 18.4 24.2 9.7 29.7 56.1 19.7 56.1 19.7 0 13.9.2 36.5.2 40.6 0 4.3-3 9.5-11.5 8-66-22.1-112.2-84.9-112.2-158.3 0-91.8 70.2-161.5 162-161.5S388 165.6 388 257.4c.1 73.4-44.7 136.3-110.7 158.3zm-98.1-61.1c-1.9.4-3.7-.4-3.9-1.7-.2-1.5 1.1-2.8 3-3.2 1.9-.2 3.7.6 3.9 1.9.3 1.3-1 2.6-3 3zm-9.5-.9c0 1.3-1.5 2.4-3.5 2.4-2.2.2-3.7-.9-3.7-2.4 0-1.3 1.5-2.4 3.5-2.4 1.9-.2 3.7.9 3.7 2.4zm-13.7-1.1c-.4 1.3-2.4 1.9-4.1 1.3-1.9-.4-3.2-1.9-2.8-3.2.4-1.3 2.4-1.9 4.1-1.5 2 .6 3.3 2.1 2.8 3.4zm-12.3-5.4c-.9 1.1-2.8.9-4.3-.6-1.5-1.3-1.9-3.2-.9-4.1.9-1.1 2.8-.9 4.3.6 1.3 1.3 1.8 3.3.9 4.1zm-9.1-9.1c-.9.6-2.6 0-3.7-1.5s-1.1-3.2 0-3.9c1.1-.9 2.8-.2 3.7 1.3 1.1 1.5 1.1 3.3 0 4.1zm-6.5-9.7c-.9.9-2.4.4-3.5-.6-1.1-1.3-1.3-2.8-.4-3.5.9-.9 2.4-.4 3.5.6 1.1 1.3 1.3 2.8.4 3.5zm-6.7-7.4c-.4.9-1.7 1.1-2.8.4-1.3-.6-1.9-1.7-1.5-2.6.4-.6 1.5-.9 2.8-.4 1.3.7 1.9 1.8 1.5 2.6z"></path>
    </symbol>

    <symbol id="icon-mail" viewBox="0 0 448 512">
      <path d="M400 32H48C21.49 32 0 53.49 0 80v352c0 26.51 21.49 48 48 48h352c26.51 0 48-21.49 48-48V80c0-26.51-21.49-48-48-48zM178.117 262.104C87.429 196.287 88.353 196.121 64 177.167V152c0-13.255 10.745-24 24-24h272c13.255 0 24 10.745 24 24v25.167c-24.371 18.969-23.434 19.124-114.117 84.938-10.5 7.655-31.392 26.12-45.883 25.894-14.503.218-35.367-18.227-45.883-25.895zM384 217.775V360c0 13.255-10.745 24-24 24H88c-13.255 0-24-10.745-24-24V217.775c13.958 10.794 33.329 25.236 95.303 70.214 14.162 10.341 37.975 32.145 64.694 32.01 26.887.134 51.037-22.041 64.72-32.025 61.958-44.965 81.325-59.406 95.283-70.199z"></path>
    </symbol>

    <symbol id="icon-goodreads" viewBox="0 0 448 512">
      <path d="M299.9 191.2c5.1 37.3-4.7 79-35.9 100.7-22.3 15.5-52.8 14.1-70.8 5.7-37.1-17.3-49.5-58.6-46.8-97.2 4.3-60.9 40.9-87.9 75.3-87.5 46.9-.2 71.8 31.8 78.2 78.3zM448 88v336c0 30.9-25.1 56-56 56H56c-30.9 0-56-25.1-56-56V88c0-30.9 25.1-56 56-56h336c30.9 0 56 25.1 56 56zM330 313.2s-.1-34-.1-217.3h-29v40.3c-.8.3-1.2-.5-1.6-1.2-9.6-20.7-35.9-46.3-76-46-51.9.4-87.2 31.2-100.6 77.8-4.3 14.9-5.8 30.1-5.5 45.6 1.7 77.9 45.1 117.8 112.4 115.2 28.9-1.1 54.5-17 69-45.2.5-1 1.1-1.9 1.7-2.9.2.1.4.1.6.2.3 3.8.2 30.7.1 34.5-.2 14.8-2 29.5-7.2 43.5-7.8 21-22.3 34.7-44.5 39.5-17.8 3.9-35.6 3.8-53.2-1.2-21.5-6.1-36.5-19-41.1-41.8-.3-1.6-1.3-1.3-2.3-1.3h-26.8c.8 10.6 3.2 20.3 8.5 29.2 24.2 40.5 82.7 48.5 128.2 37.4 49.9-12.3 67.3-54.9 67.4-106.3z"></path>
    </symbol>

    <symbol id="icon-linkedin" viewBox="0 0 448 512">
      <path d="M416 32H31.9C14.3 32 0 46.5 0 64.3v383.4C0 465.5 14.3 480 31.9 480H416c17.6 0 32-14.5 32-32.3V64.3c0-17.8-14.4-32.3-32-32.3zM135.4 416H69V202.2h66.5V416zm-33.2-243c-21.3 0-38.5-17.3-38.5-38.5S80.9 96 102.2 96c21.2 0 38.5 17.3 38.5 38.5 0 21.3-17.2 38.5-38.5 38.5zm282.1 243h-66.4V312c0-24.8-.5-56.7-34.5-56.7-34.6 0-39.9 27-39.9 54.9V416h-66.4V202.2h63.7v29.2h.9c8.9-16.8 30.6-34.5 62.9-34.5 67.2 0 79.7 44.3 79.7 101.9V416z"></path>
    </symbol>

    <symbol id="icon-rss" viewBox="0 0 448 512">
      <path d="M400 32H48C21.49 32 0 53.49 0 80v352c0 26.51 21.49 48 48 48h352c26.51 0 48-21.49 48-48V80c0-26.51-21.49-48-48-48zM112 416c-26.51 0-48-21.49-48-48s21.49-48 48-48 48 21.49 48 48-21.49 48-48 48zm157.533 0h-34.335c-6.011 0-11.051-4.636-11.442-10.634-5.214-80.05-69.243-143.92-149.123-149.123-5.997-.39-10.633-5.431-10.633-11.441v-34.335c0-6.535 5.468-11.777 11.994-11.425 110.546 5.974 198.997 94.536 204.964 204.964.352 6.526-4.89 11.994-11.425 11.994zm103.027 0h-34.334c-6.161 0-11.175-4.882-11.427-11.038-5.598-136.535-115.204-246.161-251.76-251.76C68.882 152.949 64 147.935 64 141.774V107.44c0-6.454 5.338-11.664 11.787-11.432 167.83 6.025 302.21 141.191 308.205 308.205.232 6.449-4.978 11.787-11.432 11.787z"></path>
    </symbol>

    <symbol id="icon-twitter" viewBox="0 0 448 512">
      <path d="M400 32H48C21.5 32 0 53.5 0 80v352c0 26.5 21.5 48 48 48h352c26.5 0 48-21.5 48-48V80c0-26.5-21.5-48-48-48zm-48.9 158.8c.2 2.8.2 5.7.2 8.5 0 86.7-66 186.6-186.6 186.6-37.2 0-71.7-10.8-100.7-29.4 5.3.6 10.4.8 15.8.8 30.7 0 58.9-10.4 81.4-28-28.8-.6-53-19.5-61.3-45.5 10.1 1.5 19.2 1.5 29.6-1.2-30-6.1-52.5-32.5-52.5-64.4v-.8c8.7 4.9 18.9 7.9 29.6 8.3a65.447 65.447 0 0 1-29.2-54.6c0-12.2 3.2-23.4 8.9-33.1 32.3 39.8 80.8 65.8 135.2 68.6-9.3-44.5 24-80.6 64-80.6 18.9 0 35.9 7.9 47.9 20.7 14.8-2.8 29-8.3 41.6-15.8-4.9 15.2-15.2 28-28.8 36.1 13.2-1.4 26-5.1 37.8-10.2-8.9 13.1-20.1 24.7-32.9 34z"></path>
    </symbol>
  </defs>
  </svg>

<div class="navbar">
  <div class="container">
    <div class="title">
      <h1><a href="/">Anthony Galea</a></h1>
    </div>
    <div class="links">
      <a href="https://twitter.com/anthonygalea" target="_blank"><svg class="icon"><use xlink:href="#icon-twitter"></use></svg></a>
      <a href="https://github.com/anthonygalea" target="_blank"><svg class="icon"><use xlink:href="#icon-github"></use></svg></a>
      <a href="https://goodreads.com/anthonygalea" target="_blank"><svg class="icon"><use xlink:href="#icon-goodreads"></use></svg></a>
      <a href="https://www.linkedin.com/in/anthonygalea" target="_blank"><svg class="icon"><use xlink:href="#icon-linkedin"></use></svg></a>
      <a href="mailto:anthony.galea@gmail.com" target="_blank"><svg class="icon"><use xlink:href="#icon-mail"></use></svg></a>
      <a href="https://www.anthony-galea.com/index.xml" type="application/rss+xml" target="_blank"><svg class="icon"><use xlink:href="#icon-rss"></use></svg></a>
    </div>
  </div>
</div>

<div class="content">
  <div class="post">
    <div class="post-header">
      <h1 class="post-title">Simulating a parking garage with Clojure Refs</h1>
      <span class="post-date">
      Jul 21, 2016 &middot; 6 minute read
      
      <a class="label" href="https://www.anthony-galea.com/categories/clojure">clojure</a>
      

      
      </span>
    </div>
    <div class="paragraph">
<p>In this post, we will use a simple problem to illustrate <a href="http://clojure.org/reference/refs">Clojure Refs</a>. All sources are on <a href="https://github.com/anthonygalea/garage-simulation">GitHub</a>. The problem is to simulate operations on a garage used for parking vehicles.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="/images/2016-07-21-parking.png" alt="2016 07 21 parking">
</div>
</div>
<div class="paragraph">
<p>The vehicles are uniquely identified using their <code>licence plate</code>. We will represent locations in the garage with vectors like <code>[1 2]</code>. This vector would represent parking space 2 on level 1. The operations required are:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="clojure"><span></span><span class="tok-p">(</span><span class="tok-kd">defn </span><span class="tok-nv">locate-vehicle</span>
  <span class="tok-s">&quot;Given a licence plate, returns the location of a vehicle as a vector with the</span>
<span class="tok-s">   level and parking space number, nil if not present.&quot;</span>
  <span class="tok-p">[</span><span class="tok-nv">licence-plate</span><span class="tok-p">])</span>

<span class="tok-p">(</span><span class="tok-kd">defn </span><span class="tok-nv">number-of-free-parking-spaces</span>
  <span class="tok-s">&quot;Returns the current number of free parking spaces in the garage.&quot;</span>
  <span class="tok-p">[])</span>

<span class="tok-p">(</span><span class="tok-kd">defn </span><span class="tok-nv">enter-garage!</span>
   <span class="tok-s">&quot;Simulates a vehicle entering the garage. Return the state of the garage if</span>
<span class="tok-s">   there is still free space, nil if no empty parking space exists.&quot;</span>
  <span class="tok-p">[</span><span class="tok-nv">licence-plate</span><span class="tok-p">])</span>

<span class="tok-p">(</span><span class="tok-kd">defn </span><span class="tok-nv">exit-garage!</span>
  <span class="tok-s">&quot;Simulates a vehicle exiting the garage. Returns the state of the garage if</span>
<span class="tok-s">   such a vehicle exists in the garage, nil otherwise.&quot;</span>
  <span class="tok-p">[</span><span class="tok-nv">licence-plate</span><span class="tok-p">])</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>We can describe the number of parking spaces on each garage level with a map. For example if our garage has two parking levels, each holding 15 and 10 parking spaces respectively, the map will be:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="clojure"><span></span><span class="tok-p">(</span><span class="tok-k">def </span><span class="tok-nv">parking-spaces</span> <span class="tok-p">{</span><span class="tok-mi">0</span> <span class="tok-mi">15</span>
                     <span class="tok-mi">1</span> <span class="tok-mi">10</span><span class="tok-p">})</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>This map will be used to initialize the state of the garage:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="clojure"><span></span><span class="tok-p">(</span><span class="tok-kd">defn </span><span class="tok-nv">initialize-garage!</span>
  <span class="tok-s">&quot;Sets the initial state of the garage.&quot;</span>
  <span class="tok-p">[</span><span class="tok-nv">parking-spaces</span><span class="tok-p">])</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Based on the signatures of the operations we have defined above, we could write a few tests using <a href="https://github.com/marick/Midje">midje</a> to indicate how the operations could be used:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="clojure"><span></span><span class="tok-p">(</span><span class="tok-nf">against-background</span>
 <span class="tok-p">[(</span><span class="tok-nf">before</span> <span class="tok-ss">:facts</span> <span class="tok-p">(</span><span class="tok-nf">initialize-garage!</span> <span class="tok-p">{</span><span class="tok-mi">0</span> <span class="tok-mi">2</span> <span class="tok-mi">1</span> <span class="tok-mi">1</span><span class="tok-p">}))]</span>

 <span class="tok-p">(</span><span class="tok-nf">fact</span> <span class="tok-s">&quot;After a vehicle enters the garage it should be possible to locate it.&quot;</span>
       <span class="tok-p">(</span><span class="tok-k">let </span><span class="tok-p">[</span><span class="tok-nv">licence-plate</span> <span class="tok-s">&quot;ASDF001&quot;</span><span class="tok-p">]</span>
           <span class="tok-p">(</span><span class="tok-nf">enter-garage!</span> <span class="tok-nv">licence-plate</span><span class="tok-p">)</span>
           <span class="tok-p">(</span><span class="tok-nf">locate-vehicle</span> <span class="tok-nv">licence-plate</span><span class="tok-p">))</span> <span class="tok-nv">=&gt;</span> <span class="tok-p">[</span><span class="tok-mi">0</span> <span class="tok-mi">0</span><span class="tok-p">])</span>

 <span class="tok-p">(</span><span class="tok-nf">fact</span> <span class="tok-s">&quot;If an attempt to locate an unknown vehicle is made nil should be</span>
<span class="tok-s">       returned.&quot;</span>
       <span class="tok-p">(</span><span class="tok-nf">locate-vehicle</span> <span class="tok-s">&quot;unknown licence plate&quot;</span><span class="tok-p">)</span> <span class="tok-nv">=&gt;</span> <span class="tok-nv">nil</span><span class="tok-p">)</span>

 <span class="tok-p">(</span><span class="tok-nf">fact</span> <span class="tok-s">&quot;After a vehicle enters the garage the number of free parking spaces</span>
<span class="tok-s">        should be one less than before.&quot;</span>
       <span class="tok-p">(</span><span class="tok-k">let </span><span class="tok-p">[</span><span class="tok-nv">free-parking-spaces-before</span> <span class="tok-p">(</span><span class="tok-nf">number-of-free-parking-spaces</span><span class="tok-p">)]</span>
         <span class="tok-p">(</span><span class="tok-nf">enter-garage!</span> <span class="tok-s">&quot;ASDF001&quot;</span><span class="tok-p">)</span>
         <span class="tok-p">(</span><span class="tok-nf">number-of-free-parking-spaces</span><span class="tok-p">)</span> <span class="tok-nv">=&gt;</span> <span class="tok-p">(</span><span class="tok-nb">dec </span><span class="tok-nv">free-parking-spaces-before</span><span class="tok-p">)))</span>

 <span class="tok-p">(</span><span class="tok-nf">fact</span> <span class="tok-s">&quot;If too many vehicles try to enter the garage nil should be returned.&quot;</span>
       <span class="tok-p">(</span><span class="tok-nf">enter-garage!</span> <span class="tok-s">&quot;ASDF001&quot;</span><span class="tok-p">)</span>
       <span class="tok-p">(</span><span class="tok-nf">enter-garage!</span> <span class="tok-s">&quot;ASDF002&quot;</span><span class="tok-p">)</span>
       <span class="tok-p">(</span><span class="tok-nf">enter-garage!</span> <span class="tok-s">&quot;ASDF003&quot;</span><span class="tok-p">)</span>
       <span class="tok-p">(</span><span class="tok-nf">enter-garage!</span> <span class="tok-s">&quot;ASDF004&quot;</span><span class="tok-p">)</span> <span class="tok-nv">=&gt;</span> <span class="tok-nv">nil</span><span class="tok-p">)</span>

 <span class="tok-p">(</span><span class="tok-nf">fact</span> <span class="tok-s">&quot;Given a vehicle entered the garage it should be possible for that</span>
<span class="tok-s">       vehicle to exit the garage.&quot;</span>
       <span class="tok-p">(</span><span class="tok-k">let </span><span class="tok-p">[</span><span class="tok-nv">licence-plate</span> <span class="tok-s">&quot;ASDF001&quot;</span>
             <span class="tok-nv">free-parking-spaces-before</span> <span class="tok-p">(</span><span class="tok-nf">number-of-free-parking-spaces</span><span class="tok-p">)]</span>
         <span class="tok-p">(</span><span class="tok-nf">enter-garage!</span> <span class="tok-nv">licence-plate</span><span class="tok-p">)</span>
         <span class="tok-p">(</span><span class="tok-nf">exit-garage!</span> <span class="tok-nv">licence-plate</span><span class="tok-p">)</span> <span class="tok-nv">=&gt;</span> <span class="tok-p">{}</span>
         <span class="tok-p">(</span><span class="tok-nf">number-of-free-parking-spaces</span><span class="tok-p">)</span> <span class="tok-nv">=&gt;</span> <span class="tok-nv">free-parking-spaces-before</span>
         <span class="tok-p">(</span><span class="tok-nf">locate-vehicle</span> <span class="tok-nv">licence-plate</span><span class="tok-p">)</span> <span class="tok-nv">=&gt;</span> <span class="tok-nv">nil</span><span class="tok-p">))</span>

 <span class="tok-p">(</span><span class="tok-nf">fact</span> <span class="tok-s">&quot;If an unknown vehicle is requested to exit the garage nil should be</span>
<span class="tok-s">       returned.&quot;</span>
       <span class="tok-p">(</span><span class="tok-nf">exit-garage!</span> <span class="tok-s">&quot;ASDF001&quot;</span><span class="tok-p">)</span> <span class="tok-nv">=&gt;</span> <span class="tok-nv">nil</span><span class="tok-p">))</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Before we move on to the implementation, what is a <code>ref</code>? In Clojure data is immutable, so we have constructs to model the <code>state</code> of something as it changes over time. The "something" we model has an <code>identity</code> and this identity can refer to various snapshots of its <code>state</code> over time. Let&#8217;s start with a simpler construct, the <code>atom</code>. This is perhaps better explained with an example. Start a REPL and follow along:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="clojure"><span></span><span class="tok-c1">;; declare an empty map called vehicles</span>
<span class="tok-p">(</span><span class="tok-k">def </span><span class="tok-nv">vehicles</span> <span class="tok-p">{})</span>
<span class="tok-c1">;; next we apply conj to it to add a new vehicle and it&#39;s location in the garage</span>
<span class="tok-p">(</span><span class="tok-nb">conj </span><span class="tok-nv">vehicles</span> <span class="tok-p">[</span><span class="tok-s">&quot;JAFA017&quot;</span> <span class="tok-p">[</span><span class="tok-mi">1</span> <span class="tok-mi">1</span><span class="tok-p">]])</span>
<span class="tok-c1">;; =&gt; {&quot;JAFA017&quot; [1 1]}</span>
<span class="tok-c1">;; the returned map has one entry as expected but when we inspect vehicles we find it&#39;s still empty:</span>
<span class="tok-nv">vehicles</span>
<span class="tok-c1">;; =&gt; {}</span>
<span class="tok-c1">;; oh right, vehicles is immutable</span>

<span class="tok-c1">;; we need a way to update vehicles to the new state so we turn vehicles into an atom:</span>
<span class="tok-p">(</span><span class="tok-k">def </span><span class="tok-nv">vehicles</span> <span class="tok-p">(</span><span class="tok-nf">atom</span> <span class="tok-p">{}))</span>
<span class="tok-nv">vehicles</span>
<span class="tok-c1">;; =&gt; #&lt;Atom@dfdcf6c {}&gt;</span>
<span class="tok-c1">;; ok so now vehicles is not a map, it&#39;s an atom</span>
<span class="tok-c1">;; to get to the state of the atom we have to dereference it with @ like this:</span>
<span class="tok-o">@</span><span class="tok-nv">vehicles</span>
<span class="tok-c1">;; {}</span>
<span class="tok-c1">;; to change it we use swap!:</span>
<span class="tok-p">(</span><span class="tok-nf">swap!</span> <span class="tok-nv">vehicles</span> <span class="tok-nb">conj </span><span class="tok-p">[</span><span class="tok-s">&quot;JAFA017&quot;</span> <span class="tok-p">[</span><span class="tok-mi">1</span> <span class="tok-mi">1</span><span class="tok-p">]])</span>
<span class="tok-c1">;; =&gt; {&quot;JAFA017&quot; [1 1]})</span>
<span class="tok-c1">;; once again:</span>
<span class="tok-p">(</span><span class="tok-nf">swap!</span> <span class="tok-nv">vehicles</span> <span class="tok-nb">conj </span><span class="tok-p">[</span><span class="tok-s">&quot;HSLE328&quot;</span> <span class="tok-p">[</span><span class="tok-mi">1</span> <span class="tok-mi">2</span><span class="tok-p">]])</span>
<span class="tok-c1">;; =&gt; {&quot;HSLE328&quot; [1 2], &quot;JAFA017&quot; [1 1]}</span>
<span class="tok-c1">;; and if we check what vehicles stores:</span>
<span class="tok-o">@</span><span class="tok-nv">vehicles</span>
<span class="tok-c1">;; =&gt; {&quot;HSLE328&quot; [1 2], &quot;JAFA017&quot; [1 1]}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p><code>swap!</code> takes an atom (in this case <code>vehicles</code>), a function (in this case <code>conj</code>) and additional parameters (in this case <code>[["JAFA017"] [1 1]]</code>), reads the current value the atom refers to, applies the function to the value, and tells the atom to point to the value returned. These steps happen atomically. But what if we want to mutate two identities in a transaction? We can&#8217;t use two atoms as there is no way to <code>swap!</code> on both of them together. In this case we use <code>refs</code> and the <code>dosync</code> function:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="clojure"><span></span><span class="tok-p">(</span><span class="tok-k">def </span><span class="tok-nv">vehicles</span> <span class="tok-p">(</span><span class="tok-nb">ref </span><span class="tok-p">{}))</span>
<span class="tok-p">(</span><span class="tok-k">def </span><span class="tok-nv">empty-parking-spaces</span> <span class="tok-p">(</span><span class="tok-nb">ref </span><span class="tok-o">#</span><span class="tok-p">{}))</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>So now we have two <code>refs</code>. <code>vehicles</code> that have entered the garage will be tracked in a map using the licence plate as the key and the location assigned as the value. <code>empty-parking-spaces</code> is a set in which we will store all available parking spaces using vectors like <code>[1 3]</code> which would indicate a free space on level 1, parking space 3. Every time a vehicle enters the garage, we add it to <code>vehicles</code> and remove the parking space that was allocated from <code>empty-parking-spaces</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="clojure"><span></span><span class="tok-p">(</span><span class="tok-kd">defn </span><span class="tok-nv">enter-garage!</span>
  <span class="tok-s">&quot;Simulates a vehicle entering the garage. Return the state of the garage if</span>
<span class="tok-s">   there is still free space, nil if no empty parking space exists.&quot;</span>
  <span class="tok-p">[</span><span class="tok-nv">licence-plate</span><span class="tok-p">]</span>
  <span class="tok-p">(</span><span class="tok-nf">dosync</span>
   <span class="tok-p">(</span><span class="tok-nb">if-let </span><span class="tok-p">[</span><span class="tok-nv">parking-space</span> <span class="tok-p">(</span><span class="tok-nb">first </span><span class="tok-o">@</span><span class="tok-nv">empty-parking-spaces</span><span class="tok-p">)]</span>
     <span class="tok-p">(</span><span class="tok-nf">do</span>
       <span class="tok-p">(</span><span class="tok-nb">alter </span><span class="tok-nv">empty-parking-spaces</span> <span class="tok-nb">disj </span><span class="tok-nv">parking-space</span><span class="tok-p">)</span>
       <span class="tok-p">(</span><span class="tok-nb">alter </span><span class="tok-nv">vehicles</span> <span class="tok-nb">assoc </span><span class="tok-nv">licence-plate</span> <span class="tok-nv">parking-space</span><span class="tok-p">)))))</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Similarly for <code>exit-garage!</code> we remove the entry from <code>vehicles</code> and add the location previously occupied by the vehicle back to <code>empty-parking-spaces</code> so we can use it again in the future:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="clojure"><span></span><span class="tok-p">(</span><span class="tok-kd">defn </span><span class="tok-nv">exit-garage!</span>
  <span class="tok-s">&quot;Simulates a vehicle exiting the garage. Returns the state of the garage if</span>
<span class="tok-s">   such a vehicle exists in the garage, nil otherwise.&quot;</span>
  <span class="tok-p">[</span><span class="tok-nv">licence-plate</span><span class="tok-p">]</span>
  <span class="tok-p">(</span><span class="tok-nf">dosync</span>
   <span class="tok-p">(</span><span class="tok-nb">if-let </span><span class="tok-p">[</span><span class="tok-nv">vehicle-location</span> <span class="tok-p">(</span><span class="tok-nf">locate-vehicle</span> <span class="tok-nv">licence-plate</span><span class="tok-p">)]</span>
     <span class="tok-p">(</span><span class="tok-nf">do</span>
       <span class="tok-p">(</span><span class="tok-nb">alter </span><span class="tok-nv">empty-parking-spaces</span> <span class="tok-nb">conj </span><span class="tok-nv">vehicle-location</span><span class="tok-p">)</span>
       <span class="tok-p">(</span><span class="tok-nb">alter </span><span class="tok-nv">vehicles</span> <span class="tok-nb">dissoc </span><span class="tok-nv">licence-plate</span><span class="tok-p">)))))</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Notice that with <code>dosync</code> the operations are happening within a transaction, so we don&#8217;t need to worry about two cars potentially getting assigned the same parking space. Finally, it is trivial to define the operations <code>locate-vehicle</code> and <code>number-of-free-parking-spaces</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="clojure"><span></span><span class="tok-p">(</span><span class="tok-kd">defn </span><span class="tok-nv">locate-vehicle</span>
  <span class="tok-s">&quot;Given a licence plate, returns the location of a vehicle as a vector with the</span>
<span class="tok-s">   level and parking space number, nil if not present.&quot;</span>
  <span class="tok-p">[</span><span class="tok-nv">licence-plate</span><span class="tok-p">]</span>
  <span class="tok-p">(</span><span class="tok-o">@</span><span class="tok-nv">vehicles</span> <span class="tok-nv">licence-plate</span><span class="tok-p">))</span>

<span class="tok-p">(</span><span class="tok-kd">defn </span><span class="tok-nv">number-of-free-parking-spaces</span>
  <span class="tok-s">&quot;Returns the current number of free parking spaces in the garage.&quot;</span>
  <span class="tok-p">[]</span>
   <span class="tok-p">(</span><span class="tok-nb">count </span><span class="tok-o">@</span><span class="tok-nv">empty-parking-spaces</span><span class="tok-p">))</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>If you want to take a look at the source it&#8217;s on <a href="https://github.com/anthonygalea/garage-simulation">GitHub</a>. In the <a href="https://www.anthony-galea.com/blog/post/hello-parking-garage-meet-clojure.spec/">next post</a> we will take a look at how we can apply clojure.spec.</p>
</div>


    <div class="post-footer">
      

    
    
    
    
      
      
      
        
      
    
      
      
      
        
      
    
      
      
      
        
      
    
      
      
      
        
      
    
      
      
      
        
      
    
      
      
      
        
      
    
      
      
      
        
      
    
      
      
      
    
      
      
      
        
      
    
      
      
      
        
      
    
      
      
      
    
      
      
      
        
      
    
      
      
      
        
      
    
      
      
      
    
      
      
      
        
      
    
      
      
      
    
      
      
      
    
      
      
      
    
      
      
      
    
      
      
      
    
      
      
      
    
      
      
      
    
      
      
      
    
      
      
      
    
      
      
      
    
      
      
      
    
      
      
      
    
      
      
      
    
      
      
      
    
      
      
      
    
      
      
      
    

    <h1>See also</h1>
      <div class="paragraph">
        <ul>
        
          
          
          
            <li><a href="https://www.anthony-galea.com/blog/post/how-many-eggs-should-a-woodchuck-chuck/">How many eggs should a woodchuck chuck?</a> <a class="label" href="https://www.anthony-galea.com/categories/clojure">clojure</a><a class="label" href="https://www.anthony-galea.com/categories/interactive">interactive</a></li>
          
        
          
          
          
            <li><a href="https://www.anthony-galea.com/blog/post/modeling-big-two/">Modeling Big two</a> <a class="label" href="https://www.anthony-galea.com/categories/clojure">clojure</a><a class="label" href="https://www.anthony-galea.com/categories/interactive">interactive</a></li>
          
        
          
          
          
            <li><a href="https://www.anthony-galea.com/blog/post/visualizing-the-prisoners-dilemma/">Visualizing the Prisoner&#39;s Dilemma</a> <a class="label" href="https://www.anthony-galea.com/categories/clojure">clojure</a><a class="label" href="https://www.anthony-galea.com/categories/interactive">interactive</a></li>
          
        
          
          
          
            <li><a href="https://www.anthony-galea.com/blog/post/iterated-function-systems/">Iterated Function Systems</a> <a class="label" href="https://www.anthony-galea.com/categories/clojure">clojure</a><a class="label" href="https://www.anthony-galea.com/categories/interactive">interactive</a></li>
          
        
          
          
          
            <li><a href="https://www.anthony-galea.com/blog/post/the-template-method-pattern/">The Template Method Pattern</a> <a class="label" href="https://www.anthony-galea.com/categories/design-patterns">design-patterns</a><a class="label" href="https://www.anthony-galea.com/categories/java">java</a><a class="label" href="https://www.anthony-galea.com/categories/scala">scala</a><a class="label" href="https://www.anthony-galea.com/categories/kotlin">kotlin</a><a class="label" href="https://www.anthony-galea.com/categories/clojure">clojure</a></li>
          
        
          
          
          
            <li><a href="https://www.anthony-galea.com/blog/post/4clojure-solutions-over-time/">4Clojure solutions over time</a> <a class="label" href="https://www.anthony-galea.com/categories/clojure">clojure</a></li>
          
        
          
          
          
            <li><a href="https://www.anthony-galea.com/blog/post/hello-parking-garage-meet-clojure.spec/">Hello parking garage, meet clojure.spec</a> <a class="label" href="https://www.anthony-galea.com/categories/clojure">clojure</a></li>
          
        
          
          
          
        
          
          
          
            <li><a href="https://www.anthony-galea.com/blog/post/using-datomic-in-a-simple-use-case/">Using Datomic in a simple use case</a> <a class="label" href="https://www.anthony-galea.com/categories/clojure">clojure</a></li>
          
        
          
          
          
            <li><a href="https://www.anthony-galea.com/blog/post/solutions-to-4clojure-medium-problems/">Solutions to 4Clojure Medium Problems</a> <a class="label" href="https://www.anthony-galea.com/categories/clojure">clojure</a><a class="label" href="https://www.anthony-galea.com/categories/interactive">interactive</a></li>
          
        
          
          
          
        
          
          
          
            <li><a href="https://www.anthony-galea.com/blog/post/getting-started-with-compojure-api/">Getting started with compojure-api</a> <a class="label" href="https://www.anthony-galea.com/categories/clojure">clojure</a></li>
          
        
          
          
          
            <li><a href="https://www.anthony-galea.com/blog/post/solutions-to-4clojure-easy-problems/">Solutions to 4Clojure Easy Problems</a> <a class="label" href="https://www.anthony-galea.com/categories/clojure">clojure</a><a class="label" href="https://www.anthony-galea.com/categories/interactive">interactive</a></li>
          
        
          
          
          
        
          
          
          
            <li><a href="https://www.anthony-galea.com/blog/post/solutions-to-4clojure-elementary-problems/">Solutions to 4Clojure Elementary Problems</a> <a class="label" href="https://www.anthony-galea.com/categories/clojure">clojure</a><a class="label" href="https://www.anthony-galea.com/categories/interactive">interactive</a></li>
          
        
          
          
          
        
          
          
          
        
          
          
          
        
          
          
          
        
          
          
          
        
          
          
          
        
          
          
          
        
          
          
          
        
          
          
          
        
          
          
          
        
          
          
          
        
          
          
          
        
          
          
          
        
          
          
          
        
          
          
          
        
          
          
          
        
        
            
            
            
            
        
            
            
            
            
        
            
            
            
            
        
            
            
            
            
        
            
            
            
            
        
            
            
            
            
        
            
            
            
            
        
            
            
            
            
        
            
            
            
            
        
            
            
            
            
        
            
            
            
            
            <li><a href="https://www.anthony-galea.com/blog/post/how-to-fail-at-almost-everything-and-still-win-big-scott-adams/">How to Fail at Almost Everything and Still Win Big - Scott Adams</a> <a class="label" href="https://www.anthony-galea.com/categories/book-notes">book-notes</a></li>
            
        
            
            
            
            
        
            
            
            
            
        
            
            
            
            
            <li><a href="https://www.anthony-galea.com/blog/post/an-astronauts-guide-to-life-on-earth-christian-hadfield/">An Astronaut&#39;s Guide to Life on Earth - Christian Hadfield</a> <a class="label" href="https://www.anthony-galea.com/categories/book-notes">book-notes</a></li>
            
        
            
            
            
            
        
            
            
            
            
            <li><a href="https://www.anthony-galea.com/blog/post/better-apis-with-java-optional/">Better APIs with Java Optional</a> <a class="label" href="https://www.anthony-galea.com/categories/java">java</a><a class="label" href="https://www.anthony-galea.com/categories/groovy">groovy</a></li>
            
        
            
            
            
            
            <li><a href="https://www.anthony-galea.com/blog/post/the-builder-pattern-in-java/">The Builder Pattern in Java</a> <a class="label" href="https://www.anthony-galea.com/categories/design-patterns">design-patterns</a><a class="label" href="https://www.anthony-galea.com/categories/java">java</a></li>
            
        
            
            
            
            
            <li><a href="https://www.anthony-galea.com/blog/post/an-introduction-to-load-testing-with-gatling/">An Introduction to Load Testing with Gatling</a> <a class="label" href="https://www.anthony-galea.com/categories/testing">testing</a><a class="label" href="https://www.anthony-galea.com/categories/http">http</a><a class="label" href="https://www.anthony-galea.com/categories/scala">scala</a></li>
            
        
            
            
            
            
        
            
            
            
            
        
            
            
            
            
        
            
            
            
            
        
            
            
            
            
        
            
            
            
            
        
            
            
            
            
        
            
            
            
            
        
            
            
            
            
        
            
            
            
            
        
            
            
            
            
        
            
            
            
            
        
            
            
            
            
        
        </ul>
    </div>
    </div>
  
  

</div>




</div>

<link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.29.0/codemirror.min.css">
<link crossorigin="anonymous" rel="stylesheet" id="stag-google-Montserrat-css" href="https://fonts.googleapis.com/css?family=Montserrat:400,700" type="text/css" media="all">
<link rel="stylesheet" href="https://www.anthony-galea.com/css/below-the-fold.min.css">

<script>
 window.klipse_settings = {
     selector: '.language-klipse',
     codemirror_options_in: {
         indentUnit: 2,
         lineWrapping: true,
         lineNumbers: true,
         autoCloseBrackets: true
     }
 };
</script>
<script src="https://storage.googleapis.com/app.klipse.tech/plugin/js/klipse_plugin.js"></script>


<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-MML-AM_HTMLorMML" type="text/javascript"></script>
<script type="text/x-mathjax-config">
MathJax.Hub.Config({
  tex2jax: {
    inlineMath: [["\\(", "\\)"]],
    displayMath: [["\\[", "\\]"]],
    ignoreClass: "nostem|nolatexmath"
  },
  asciimath2jax: {
    delimiters: [["\\$", "\\$"]],
    ignoreClass: "nostem|noasciimath"
  },
  TeX: { equationNumbers: { autoNumber: "none" } }
});
</script>
</body>
</html>

